<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸‰äººèšæ™ºå·¥å…· - å¿«é€Ÿæœç´¢</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .search-header {
            padding: 15px 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .search-input {
            width: 100%;
            padding: 12px 16px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            outline: none;
            background: rgba(255, 255, 255, 0.9);
            color: #333;
        }

        .search-input::placeholder {
            color: #999;
        }

        .results-container {
            max-height: 320px;
            overflow-y: auto;
            padding: 8px 0;
        }

        .result-item {
            display: flex;
            align-items: center;
            padding: 12px 20px;
            cursor: pointer;
            transition: all 0.2s;
            border-left: 3px solid transparent;
        }

        .result-item:hover,
        .result-item.selected {
            background: rgba(102, 126, 234, 0.1);
            border-left-color: #667eea;
        }

        .result-logo {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 16px;
            font-weight: bold;
            margin-right: 12px;
            flex-shrink: 0;
        }

        .result-logo img {
            width: 100%;
            height: 100%;
            border-radius: 8px;
            object-fit: cover;
        }

        .result-content {
            flex: 1;
            min-width: 0;
        }

        .result-title {
            font-size: 14px;
            font-weight: 600;
            color: #262626;
            margin-bottom: 2px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .result-description {
            font-size: 12px;
            color: #8c8c8c;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .result-category {
            font-size: 11px;
            color: #1890ff;
            background: rgba(24, 144, 255, 0.1);
            padding: 2px 6px;
            border-radius: 10px;
            margin-left: 8px;
            white-space: nowrap;
        }

        .no-results {
            padding: 40px 20px;
            text-align: center;
            color: #8c8c8c;
            font-size: 14px;
        }

        .search-footer {
            padding: 8px 20px;
            background: #f8f9fa;
            border-top: 1px solid #e8e8e8;
            font-size: 11px;
            color: #8c8c8c;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .shortcut-hint {
            display: flex;
            gap: 8px;
        }

        .shortcut-key {
            background: #fff;
            border: 1px solid #d9d9d9;
            border-radius: 3px;
            padding: 2px 6px;
            font-family: monospace;
        }

        /* æ»šåŠ¨æ¡æ ·å¼ */
        .results-container::-webkit-scrollbar {
            width: 6px;
        }

        .results-container::-webkit-scrollbar-track {
            background: transparent;
        }

        .results-container::-webkit-scrollbar-thumb {
            background: #d9d9d9;
            border-radius: 3px;
        }

        .results-container::-webkit-scrollbar-thumb:hover {
            background: #bfbfbf;
        }

        /* é€šçŸ¥æ ·å¼ */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            padding: 16px 24px;
            display: flex;
            align-items: center;
            gap: 12px;
            z-index: 1000;
            animation: slideIn 0.3s ease-out;
            max-width: 400px;
        }

        @keyframes slideIn {
            from {
                transform: translateX(120%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(120%);
                opacity: 0;
            }
        }

        .notification.success {
            border-left: 4px solid #52c41a;
        }

        .notification.error {
            border-left: 4px solid #ff4d4f;
        }

        .notification.info {
            border-left: 4px solid #1890ff;
        }

        .notification-icon {
            font-size: 20px;
        }

        .notification.success .notification-icon {
            color: #52c41a;
        }

        .notification.error .notification-icon {
            color: #ff4d4f;
        }

        .notification.info .notification-icon {
            color: #1890ff;
        }

        .notification-message {
            flex: 1;
            font-size: 14px;
            color: #262626;
        }

        .match-indicator {
            font-size: 11px;
            color: #fff;
            background-color: #1890ff;
            padding: 2px 6px;
            border-radius: 10px;
            margin-left: 8px;
            text-align: center;
            font-weight: 500;
        }

        .search-tip {
            font-size: 12px;
            color: #1890ff;
            margin-top: 8px;
        }
    </style>
</head>
<body>
    <div class="search-header">
        <input type="text" class="search-input" placeholder="æœç´¢æ’ä»¶..." id="search-input" autofocus>
    </div>
    
    <div class="results-container" id="results-container">
        <div class="no-results" id="no-results">å¼€å§‹è¾“å…¥ä»¥æœç´¢æ’ä»¶...</div>
    </div>
    
    <div class="search-footer">
        <div class="shortcut-hint">
            <span><span class="shortcut-key">â†‘</span><span class="shortcut-key">â†“</span> é€‰æ‹©</span>
            <span><span class="shortcut-key">Enter</span> æ‰“å¼€</span>
            <span><span class="shortcut-key">Ctrl+D</span> é’‰ä½</span>
            <span><span class="shortcut-key">Esc</span> å…³é—­</span>
        </div>
        <div id="pin-status">ä¸‰äººèšæ™ºå·¥å…·</div>
    </div>

    <script>
        const { ipcRenderer } = require('electron');
        const fs = require('fs');
        const path = require('path');

        let plugins = [];
        let pluginContents = []; // å­˜å‚¨æ’ä»¶çš„å†…å®¹ï¼ˆå¦‚æ–‡æœ¬ç‰‡æ®µï¼‰
        let filteredResults = []; // åˆå¹¶çš„æœç´¢ç»“æœ
        let selectedIndex = 0;
        let pluginSearchSettings = {}; // ç”¨æˆ·è‡ªå®šä¹‰çš„æœç´¢è®¾ç½®
        let isPinned = false; // é’‰ä½çŠ¶æ€

        const searchInput = document.getElementById('search-input');
        const resultsContainer = document.getElementById('results-container');
        const noResults = document.getElementById('no-results');
        const pinStatus = document.getElementById('pin-status');

        // ç»“æœé¡¹ç±»å‹
        const RESULT_TYPES = {
            PLUGIN: 'plugin',
            CONTENT: 'content'
        };

        // åˆå§‹åŒ–
        async function init() {
            try {
                // åŠ è½½æ’ä»¶åˆ—è¡¨
                plugins = await ipcRenderer.invoke('get-plugin-list');
                
                // åŠ è½½æ’ä»¶å†…å®¹
                await loadPluginContents();
                
                // åŠ è½½ç”¨æˆ·è®¾ç½®
                const settings = await ipcRenderer.invoke('get-settings');
                pluginSearchSettings = settings.pluginSearchSettings || {};
                
                console.log('åˆå§‹åŒ–å®Œæˆ:', { 
                    plugins: plugins.length, 
                    contents: pluginContents.length 
                });
                
                updateSearchPlaceholder();
            } catch (error) {
                console.error('åˆå§‹åŒ–å¤±è´¥:', error);
            }
        }

        // åŠ è½½æ’ä»¶å†…å®¹
        async function loadPluginContents() {
            try {
                pluginContents = [];
                
                // ä¸ºæ¯ä¸ªæ’ä»¶åŠ è½½å…¶å†…å®¹
                for (const plugin of plugins) {
                    try {
                        const contents = await ipcRenderer.invoke('get-plugin-contents', plugin.path);
                        
                        // ä¸ºæ¯ä¸ªå†…å®¹é¡¹æ·»åŠ æ’ä»¶ä¿¡æ¯
                        contents.forEach(content => {
                            pluginContents.push({
                                ...content,
                                pluginName: plugin.name,
                                pluginPath: plugin.path,
                                type: RESULT_TYPES.CONTENT,
                                contentType: content.type || 'unknown' // ä¿å­˜åŸå§‹çš„typeä½œä¸ºcontentType
                            });
                        });
                    } catch (error) {
                        console.error(`åŠ è½½æ’ä»¶ ${plugin.name} çš„å†…å®¹å¤±è´¥:`, error);
                    }
                }
                
                console.log(`å…±åŠ è½½ ${pluginContents.length} ä¸ªå†…å®¹é¡¹`);
            } catch (error) {
                console.error('åŠ è½½æ’ä»¶å†…å®¹å¤±è´¥:', error);
            }
        }

        // æ›´æ–°æœç´¢æç¤º
        function updateSearchPlaceholder() {
            const totalItems = plugins.length + pluginContents.length;
            searchInput.placeholder = `æœç´¢ ${plugins.length} ä¸ªæ’ä»¶å’Œ ${pluginContents.length} ä¸ªå†…å®¹é¡¹...å¯ç”¨ç©ºæ ¼åˆ†éš”å¤šä¸ªå…³é”®è¯`;
        }

        // æœç´¢å‡½æ•°
        function search(query) {
            if (!query.trim()) {
                filteredResults = [];
                renderResults();
                return;
            }

            // åˆ†å‰²å¤šä¸ªå…³é”®è¯ï¼ˆæŒ‰ç©ºæ ¼åˆ†å‰²ï¼‰
            const keywords = query.toLowerCase().split(/\s+/).filter(k => k.length > 0);
            const results = [];

            // æœç´¢æ’ä»¶
            plugins.forEach(plugin => {
                let score = 0;
                const searchTerms = [plugin.name];
                
                // æ·»åŠ ç”¨æˆ·è‡ªå®šä¹‰å…³é”®è¯
                const customSettings = pluginSearchSettings[plugin.name];
                if (customSettings && customSettings.enabled && customSettings.keywords.length > 0) {
                    searchTerms.push(...customSettings.keywords);
                }

                // ç»Ÿè®¡åŒ¹é…çš„å…³é”®è¯æ•°é‡
                const matchedKeywords = new Set();
                
                // è®¡ç®—åŒ¹é…åˆ†æ•°
                for (const term of searchTerms) {
                    const termLower = term.toLowerCase();
                    
                    // æ£€æŸ¥æ¯ä¸ªå…³é”®è¯
                    for (const keyword of keywords) {
                        if (termLower.includes(keyword)) {
                            score += termLower === keyword ? 100 : 50;
                            matchedKeywords.add(keyword);
                        }
                    }
                }

                // æ£€æŸ¥æè¿°ä¸­çš„å…³é”®è¯åŒ¹é…
                if (plugin.description) {
                    const descLower = plugin.description.toLowerCase();
                    for (const keyword of keywords) {
                        if (descLower.includes(keyword)) {
                            score += 20;
                            matchedKeywords.add(keyword);
                        }
                    }
                }

                // å¤šå…³é”®è¯åŠ æƒï¼šæ¯å¤šåŒ¹é…ä¸€ä¸ªå…³é”®è¯å¢åŠ é¢å¤–åˆ†æ•°
                if (matchedKeywords.size > 1) {
                    // å¦‚æœåŒ¹é…äº†å¤šä¸ªå…³é”®è¯ï¼Œé¢å¤–å¢åŠ åˆ†æ•°
                    score += (matchedKeywords.size - 1) * 50;
                }
                
                // å®Œå…¨åŒ¹é…æ‰€æœ‰å…³é”®è¯çš„é¢å¤–åŠ åˆ†
                if (matchedKeywords.size === keywords.length && keywords.length > 1) {
                    score += 100; // å®Œå…¨åŒ¹é…æ‰€æœ‰å…³é”®è¯çš„å¥–åŠ±åˆ†æ•°
                }

                if (score > 0) {
                    results.push({
                        ...plugin,
                        type: RESULT_TYPES.PLUGIN,
                        score: score,
                        matchedKeywordsCount: matchedKeywords.size,
                        totalKeywords: keywords.length,
                        matchedTerm: searchTerms.find(term => 
                            keywords.some(kw => term.toLowerCase().includes(kw))
                        ) || plugin.name
                    });
                }
            });

            // æœç´¢æ’ä»¶å†…å®¹
            pluginContents.forEach(content => {
                let score = 0;
                // ç»Ÿè®¡åŒ¹é…çš„å…³é”®è¯æ•°é‡
                const matchedKeywords = new Set();

                // æ ‡é¢˜åŒ¹é…
                if (content.title) {
                    const titleLower = content.title.toLowerCase();
                    for (const keyword of keywords) {
                        if (titleLower.includes(keyword)) {
                            score += titleLower === keyword ? 100 : 80;
                            matchedKeywords.add(keyword);
                        }
                    }
                }

                // å†…å®¹åŒ¹é…
                if (content.content) {
                    const contentLower = content.content.toLowerCase();
                    for (const keyword of keywords) {
                        if (contentLower.includes(keyword)) {
                            score += 30;
                            matchedKeywords.add(keyword);
                        }
                    }
                }

                // é¢„è§ˆåŒ¹é…
                if (content.preview) {
                    const previewLower = content.preview.toLowerCase();
                    for (const keyword of keywords) {
                        if (previewLower.includes(keyword)) {
                            score += 20;
                            matchedKeywords.add(keyword);
                        }
                    }
                }

                // å¤šå…³é”®è¯åŠ æƒï¼šæ¯å¤šåŒ¹é…ä¸€ä¸ªå…³é”®è¯å¢åŠ é¢å¤–åˆ†æ•°
                if (matchedKeywords.size > 1) {
                    // å¦‚æœåŒ¹é…äº†å¤šä¸ªå…³é”®è¯ï¼Œé¢å¤–å¢åŠ åˆ†æ•°
                    score += (matchedKeywords.size - 1) * 50;
                }
                
                // å®Œå…¨åŒ¹é…æ‰€æœ‰å…³é”®è¯çš„é¢å¤–åŠ åˆ†
                if (matchedKeywords.size === keywords.length && keywords.length > 1) {
                    score += 100; // å®Œå…¨åŒ¹é…æ‰€æœ‰å…³é”®è¯çš„å¥–åŠ±åˆ†æ•°
                }

                if (score > 0) {
                    results.push({
                        ...content,
                        score: score,
                        matchedKeywordsCount: matchedKeywords.size,
                        totalKeywords: keywords.length
                    });
                }
            });

            // æŒ‰åˆ†æ•°æ’åºï¼ŒåŒåˆ†æ•°æ—¶ä¼˜å…ˆè€ƒè™‘åŒ¹é…å…³é”®è¯æ•°é‡æœ€å¤šçš„ç»“æœ
            filteredResults = results.sort((a, b) => {
                if (b.score !== a.score) {
                    return b.score - a.score; // å…ˆæŒ‰åˆ†æ•°æ’åº
                }
                // åˆ†æ•°ç›¸åŒæ—¶ï¼ŒæŒ‰åŒ¹é…çš„å…³é”®è¯æ•°é‡æ’åº
                return b.matchedKeywordsCount - a.matchedKeywordsCount;
            });
            
            selectedIndex = 0;
            renderResults();
        }

        // æ¸²æŸ“æœç´¢ç»“æœ
        function renderResults() {
            if (filteredResults.length === 0) {
                // æ£€æŸ¥æ˜¯å¦æ˜¯ç©ºè¾“å…¥
                if (!searchInput.value.trim()) {
                    resultsContainer.innerHTML = '<div class="no-results">å¼€å§‹è¾“å…¥ä»¥æœç´¢æ’ä»¶å’Œå†…å®¹...</div>';
                } else {
                    resultsContainer.innerHTML = `
                        <div class="no-results">
                            <p>æ²¡æœ‰æ‰¾åˆ°åŒ¹é…çš„ç»“æœ</p>
                            <p class="search-tip">æç¤ºï¼šå¯ä»¥ä½¿ç”¨ç©ºæ ¼åˆ†éš”å¤šä¸ªå…³é”®è¯è¿›è¡Œç²¾ç¡®æœç´¢</p>
                        </div>
                    `;
                }
                return;
            }

            const html = filteredResults.map((result, index) => {
                const isSelected = index === selectedIndex;
                const selectedClass = isSelected ? 'selected' : '';
                
                if (result.type === RESULT_TYPES.PLUGIN) {
                    // æ’ä»¶ç»“æœ - ä¼˜å…ˆä½¿ç”¨ logo.icoï¼Œå¦åˆ™ä½¿ç”¨ logo.png
                    const logoIcoPath = path.join(result.path, 'logo.ico');
                    const logoPngPath = path.join(result.path, 'logo.png');
                    let logoPath = null;
                    let hasLogo = false;
                    
                    if (fs.existsSync(logoIcoPath)) {
                        logoPath = logoIcoPath;
                        hasLogo = true;
                    } else if (fs.existsSync(logoPngPath)) {
                        logoPath = logoPngPath;
                        hasLogo = true;
                    }
                    
                    return `
                        <div class="result-item ${selectedClass}" data-index="${index}" data-type="plugin">
                            <div class="result-logo">
                                ${hasLogo ? 
                                    `<img src="file://${logoPath.replace(/\\/g, '/')}" alt="${result.name}">` :
                                    `<span>${result.name.charAt(0).toUpperCase()}</span>`
                                }
                            </div>
                            <div class="result-content">
                                <div class="result-title">${result.name}</div>
                                <div class="result-description">${result.description}</div>
                            </div>
                            <div class="result-category">æ’ä»¶</div>
                            ${result.totalKeywords > 1 ? 
                            `<div class="match-indicator" title="åŒ¹é… ${result.matchedKeywordsCount}/${result.totalKeywords} ä¸ªå…³é”®è¯">
                                ${result.matchedKeywordsCount}/${result.totalKeywords}
                            </div>` : ''}
                        </div>
                    `;
                } else {
                    // å†…å®¹ç»“æœ
                    const isCommand = result.contentType === 'command';
                    const isTextSnippet = result.contentType === 'text-snippet';
                    
                    return `
                        <div class="result-item ${selectedClass}" data-index="${index}" data-type="content">
                            <div class="result-logo">
                                ${isCommand ? '<span>âš¡</span>' : 
                                  isTextSnippet ? '<span>ğŸ“„</span>' : 
                                  '<span>ğŸ“‹</span>'}
                            </div>
                            <div class="result-content">
                                <div class="result-title">${result.title}</div>
                                <div class="result-description">${result.preview}</div>
                            </div>
                            <div class="result-category">${result.pluginName}</div>
                            ${result.totalKeywords > 1 ? 
                            `<div class="match-indicator" title="åŒ¹é… ${result.matchedKeywordsCount}/${result.totalKeywords} ä¸ªå…³é”®è¯">
                                ${result.matchedKeywordsCount}/${result.totalKeywords}
                            </div>` : ''}
                        </div>
                    `;
                }
            }).join('');

            resultsContainer.innerHTML = html;

            // ç»‘å®šç‚¹å‡»äº‹ä»¶
            document.querySelectorAll('.result-item').forEach((item, index) => {
                item.addEventListener('click', () => {
                    selectedIndex = index;
                    selectResult();
                });
            });
        }

        // é”®ç›˜å¯¼èˆª
        function handleKeyNavigation(direction) {
            if (filteredResults.length === 0) return;

            if (direction === 'down') {
                selectedIndex = (selectedIndex + 1) % filteredResults.length;
            } else if (direction === 'up') {
                selectedIndex = selectedIndex === 0 ? filteredResults.length - 1 : selectedIndex - 1;
            }

            renderResults();
            
            // æ»šåŠ¨åˆ°é€‰ä¸­é¡¹
            const selectedElement = document.querySelector('.result-item.selected');
            if (selectedElement) {
                selectedElement.scrollIntoView({ 
                    behavior: 'smooth', 
                    block: 'nearest' 
                });
            }
        }

        // é€‰æ‹©ç»“æœ
        async function selectResult() {
            if (filteredResults.length === 0) return;

            const selectedResult = filteredResults[selectedIndex];
            
            try {
                if (selectedResult.type === RESULT_TYPES.PLUGIN) {
                    // æ‰“å¼€æ’ä»¶
                    console.log('æ­£åœ¨æ‰“å¼€æ’ä»¶:', selectedResult.name);
                    // åªä¼ é€’å¯åºåˆ—åŒ–çš„featuresæ•°æ®
                    const serializableFeatures = selectedResult.features ? selectedResult.features.map(f => ({
                        code: f.code,
                        explain: f.explain,
                        cmds: f.cmds || []
                    })) : [];
                    await ipcRenderer.invoke('run-plugin', selectedResult.path, serializableFeatures);
                    if (!isPinned) {
                        await ipcRenderer.invoke('hide-search-window');
                    }
                } else if (selectedResult.type === RESULT_TYPES.CONTENT) {
                    // å¤„ç†ä¸åŒç±»å‹çš„å†…å®¹
                    if (selectedResult.contentType === 'command') {
                        // æ’ä»¶å‘½ä»¤ï¼šæ‰“å¼€å¯¹åº”çš„æ’ä»¶
                        console.log('æ­£åœ¨æ‰§è¡Œæ’ä»¶å‘½ä»¤:', selectedResult.command);
                        await ipcRenderer.invoke('run-plugin', selectedResult.pluginPath, []);
                        if (!isPinned) {
                            await ipcRenderer.invoke('hide-search-window');
                        }
                    } else if (selectedResult.contentType === 'text-snippet') {
                        // æ–‡æœ¬ç‰‡æ®µï¼šç›´æ¥æ’å…¥å†…å®¹
                        console.log('æ­£åœ¨æ’å…¥æ–‡æœ¬ç‰‡æ®µ:', selectedResult.title);
                        await ipcRenderer.invoke('insert-content', selectedResult);
                        if (!isPinned) {
                            await ipcRenderer.invoke('hide-search-window');
                        }
                    } else {
                        // å…¶ä»–ç±»å‹å†…å®¹ï¼šé»˜è®¤æ’å…¥
                        console.log('æ­£åœ¨æ’å…¥å†…å®¹:', selectedResult.title);
                        await ipcRenderer.invoke('insert-content', selectedResult);
                        if (!isPinned) {
                            await ipcRenderer.invoke('hide-search-window');
                        }
                    }
                }
            } catch (error) {
                console.error('æ“ä½œå¤±è´¥:', error);
            }
        }

        // æœç´¢è¾“å…¥äº‹ä»¶
        searchInput.addEventListener('input', (e) => {
            search(e.target.value);
        });

        // é”®ç›˜äº‹ä»¶
        document.addEventListener('keydown', (e) => {
            switch (e.key) {
                case 'ArrowUp':
                    e.preventDefault();
                    handleKeyNavigation('up');
                    break;
                    
                case 'ArrowDown':
                    e.preventDefault();
                    handleKeyNavigation('down');
                    break;
                    
                case 'Enter':
                    e.preventDefault();
                    selectResult();
                    break;
                    
                case 'Escape':
                    e.preventDefault();
                    hideWindow();
                    break;
                    
                case 'd':
                case 'D':
                    if (e.ctrlKey) {
                        e.preventDefault();
                        togglePin();
                    }
                    break;
            }
        });

        // çª—å£æ˜¾ç¤ºæ—¶é‡ç½®çŠ¶æ€
        window.addEventListener('focus', async () => {
            searchInput.value = '';
            searchInput.focus();
            filteredResults = [];
            selectedIndex = 0;
            renderResults();
            await updatePinStatus(); // æ›´æ–°é’‰ä½çŠ¶æ€
            init(); // é‡æ–°åŠ è½½æ’ä»¶åˆ—è¡¨å’Œå†…å®¹
        });

        // çª—å£å¤±å»ç„¦ç‚¹æ—¶éšè—ï¼ˆé™¤éè¢«é’‰ä½ï¼‰
        window.addEventListener('blur', () => {
            // å»¶è¿Ÿéšè—ï¼Œé˜²æ­¢ç‚¹å‡»ç»“æœæ—¶ç«‹å³éšè—
            setTimeout(() => {
                if (!isPinned) {
                    hideWindow();
                }
            }, 200);
        });

        // ç›‘å¬ä¸»è¿›ç¨‹å‘é€çš„é’‰ä½çŠ¶æ€å˜åŒ–
        ipcRenderer.on('pin-status-changed', (event, newPinStatus) => {
            isPinned = newPinStatus;
            updatePinStatusDisplay();
        });

        // æ›´æ–°é’‰ä½çŠ¶æ€æ˜¾ç¤º
        async function updatePinStatus() {
            try {
                isPinned = await ipcRenderer.invoke('get-pin-status');
                updatePinStatusDisplay();
            } catch (error) {
                console.error('è·å–é’‰ä½çŠ¶æ€å¤±è´¥:', error);
            }
        }

        // æ›´æ–°é’‰ä½çŠ¶æ€æ˜¾ç¤ºï¼ˆå†…éƒ¨å‡½æ•°ï¼‰
        function updatePinStatusDisplay() {
            pinStatus.textContent = isPinned ? 'ğŸ“Œ å·²é’‰ä½' : 'ä¸‰äººèšæ™ºå·¥å…·';
            pinStatus.style.color = isPinned ? '#1890ff' : '#8c8c8c';
        }

        // æ˜¾ç¤ºé€šçŸ¥
        function showNotification(message, type = 'info') {
            // ç§»é™¤ç°æœ‰é€šçŸ¥
            const existingNotification = document.querySelector('.notification');
            if (existingNotification) {
                existingNotification.remove();
            }

            // åˆ›å»ºé€šçŸ¥å…ƒç´ 
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            
            const iconMap = {
                success: 'âœ“',
                error: 'âœ•',
                info: 'â„¹'
            };
            
            notification.innerHTML = `
                <span class="notification-icon">${iconMap[type] || iconMap.info}</span>
                <span class="notification-message">${message}</span>
            `;
            
            document.body.appendChild(notification);
            
            // è‡ªåŠ¨ç§»é™¤é€šçŸ¥
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease-out';
                setTimeout(() => {
                    notification.remove();
                }, 300);
            }, 3000);
        }

        // åˆ‡æ¢é’‰ä½çŠ¶æ€
        async function togglePin() {
            try {
                isPinned = await ipcRenderer.invoke('toggle-pin');
                await updatePinStatus();
                console.log('é’‰ä½çŠ¶æ€å·²åˆ‡æ¢:', isPinned);
            } catch (error) {
                console.error('åˆ‡æ¢é’‰ä½çŠ¶æ€å¤±è´¥:', error);
            }
        }

        // éšè—çª—å£ï¼ˆè€ƒè™‘é’‰ä½çŠ¶æ€ï¼‰
        async function hideWindow() {
            try {
                if (!isPinned) {
                    await ipcRenderer.invoke('hide-search-window');
                }
            } catch (error) {
                console.error('éšè—çª—å£å¤±è´¥:', error);
            }
        }

        // æ¥æ”¶é€šçŸ¥
        ipcRenderer.on('hotkey-fallback', (event, data) => {
            showNotification(`å¿«æ·é”® ${data.original} æ— æ³•ä½¿ç”¨ï¼Œå·²æ”¹ä¸º ${data.fallback}`, 'info');
        });

        // åˆå§‹åŒ–
        init();
        renderResults();
        updatePinStatus(); // åˆå§‹åŒ–æ—¶æ›´æ–°é’‰ä½çŠ¶æ€
    </script>
</body>
</html> 